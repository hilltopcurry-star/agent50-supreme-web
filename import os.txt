import os
import time
import requests
import subprocess
import sys
from agent_skills import skill_fix_missing_template, skill_fix_login_header, skill_wire_routes

class AgentQA:
    def __init__(self, project_dir, port=5000):
        self.project_dir = project_dir
        self.base_url = f"http://127.0.0.1:{port}"
        self.server_process = None

    def start_server(self):
        """Starts Flask in background."""
        app_path = os.path.join(self.project_dir, "app.py")
        
        # Pre-flight check (Skill Application)
        skill_wire_routes(self.project_dir)
        skill_fix_login_header(self.project_dir)

        self.server_process = subprocess.Popen(
            [sys.executable, app_path],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            cwd=self.project_dir
        )
        time.sleep(3) # Wait for boot

    def stop_server(self):
        if self.server_process:
            self.server_process.kill()

    def run_checks(self):
        print(f"\nüïµÔ∏è [QA] STARTING INTELLIGENT SELF-TEST...")
        
        max_retries = 3
        for attempt in range(max_retries):
            print(f"  üß™ Check Cycle #{attempt+1}...")
            self.start_server()
            
            # Check 1: Server Status
            if self.server_process.poll() is not None:
                print("  ‚ùå Server Crashed Immediately.")
                # Read Error
                out, err = self.server_process.communicate()
                print(f"  Logs: {err[:200]}...")
                
                # Apply Skills based on logs
                if skill_fix_missing_template(self.project_dir, err):
                    print("  üîÑ Restarting cycle...")
                    self.stop_server()
                    continue
                else:
                    print("  üíÄ Unknown Crash. QA Failed.")
                    return False

            # Check 2: Home Page (GET /)
            try:
                res = requests.get(self.base_url)
                if res.status_code == 200:
                    print(f"  ‚úÖ [PASS] HOME PAGE ({self.base_url}/)")
                else:
                    print(f"  ‚ùå [FAIL] HOME PAGE -> {res.status_code}")
            except:
                print("  ‚ùå [FAIL] Connection Refused")

            # Check 3: Login Logic (POST /auth/login)
            try:
                payload = {"username": "admin", "password": "123"}
                res = requests.post(f"{self.base_url}/auth/login", json=payload)
                if res.status_code == 200:
                    print(f"  ‚úÖ [PASS] LOGIN FLOW")
                    self.stop_server()
                    return True # Success!
                elif res.status_code == 415:
                    print("  ‚ùå [FAIL] Login 415 (Media Type). Fixing...")
                    skill_fix_login_header(self.project_dir)
                    self.stop_server()
                    continue
                else:
                    print(f"  ‚ö†Ô∏è [FAIL] Login returned {res.status_code}")
            except:
                pass

            self.stop_server()
            
        print("  üö® QA LIMIT REACHED. Project may be unstable.")
        return False